<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/app.css">
  <script src="../assets/js/main.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <title>TRUE ONLINE - MY PLAN สรุปรายการ</title>
</head>

<body class="bg-page-bg min-h-screen" x-data="leadForm()" x-cloak>

  <!-- Top app bar -->
  <div class="max-w-[1128px] mx-auto px-1">
    <div class="flex items-center gap-1 h-16 py-2">
      <a href="../myplan/"
        class="flex items-center justify-center w-12 h-12 rounded-full hover:bg-[rgba(48,60,70,0.08)] transition-colors shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="#303C46" />
        </svg>
      </a>
      <span class="text-[20px] font-bold text-charcoal-grey leading-8">กลับ</span>
    </div>
  </div>

  <!-- Hero: Logo + Tagline -->
  <div class="max-w-[1128px] mx-auto text-center pb-10">
    <div class="w-full">
      <img src="../assets/images/myplan-logo.png" alt="MY Plan"
        class="w-full max-w-[1128px] h-[158px] object-contain mx-auto">
    </div>
    <div class="px-4">
      <p class="text-[40px] font-bold text-flowkit-red leading-[1.4]">เลือกที่ใช่ จัดได้ตามใจคุณ</p>
      <p class="text-[32px] font-medium text-charcoal-grey leading-[1.4]">กับเน็ตบ้านไฟเบอร์ที่ดีที่สุด</p>
    </div>
  </div>

  <!-- Main Container Card -->
  <main class="max-w-[1128px] mx-auto pb-10">
    <div
      class="bg-white rounded-[16px] shadow-[0px_6px_32px_0px_rgba(0,0,0,0.08)] px-4 pt-4 pb-10 flex flex-col items-center">

      <div class="w-full flex flex-col gap-10 items-center">

        <!-- Package Details Section -->
        <div class="w-full flex flex-col gap-4 items-center">

          <!-- Gradient Header + Line items -->
          <div class="w-full border-b border-[rgba(48,60,70,0.38)] flex flex-col items-start">
            <!-- Title -->
            <p class="gradient-text text-[32px] font-medium leading-[1.4] text-center w-full">
              รายละเอียดแพ็กเกจที่คุณเลือก
            </p>

            <!-- Line Items -->
            <div class="w-full px-4 pb-4">

              <!-- Plan row -->
              <template x-if="plan">
                <div class="flex gap-4 items-end pt-4">
                  <div class="flex-1 min-w-0 flex flex-col gap-[2px] overflow-hidden">
                    <p class="text-[14px] font-medium text-[#1a1c1e] leading-[1.4]" x-text="'ความเร็ว ' + plan.speed">
                    </p>
                    <p class="text-[14px] text-charcoal-grey leading-[1.4]"
                      x-text="'สัญญา ' + plan.contract + ' เดือน'"></p>
                  </div>
                  <p class="text-[14px] font-medium text-right whitespace-nowrap shrink-0">
                    <span class="text-tol-red" x-text="plan.price"></span>
                    <span class="text-[#1a1c1e]"> บาท</span>
                  </p>
                </div>
              </template>

              <!-- Add-on rows -->
              <template x-for="addon in activeAddons" :key="addon.label">
                <div class="flex gap-4 items-end pt-4">
                  <div class="flex-1 min-w-0 flex flex-col gap-[2px] overflow-hidden">
                    <p class="text-[14px] font-medium text-[#1a1c1e] leading-[1.4]" x-text="addon.label"></p>
                  </div>
                  <p class="text-[14px] font-medium text-right whitespace-nowrap shrink-0">
                    <span class="text-tol-red" x-text="addon.price"></span>
                    <span class="text-[#1a1c1e]"> บาท</span>
                  </p>
                </div>
              </template>

              <!-- No selection fallback -->
              <template x-if="!plan">
                <div class="py-6 text-center">
                  <p class="text-[14px] text-[rgba(48,60,70,0.5)]">ยังไม่ได้เลือกแพ็กเกจ</p>
                  <a href="../myplan/" class="text-true-blue text-[14px] font-medium mt-2 inline-block">←
                    กลับไปเลือกแพ็กเกจ</a>
                </div>
              </template>

            </div>
          </div>

          <!-- Total Row -->
          <template x-if="plan">
            <div class="w-full flex flex-col items-center pt-2 pb-6">
              <div class="w-full flex items-center justify-between">
                <span class="text-[16px] font-medium text-charcoal-grey leading-[1.4]">สรุปค่าบริการรายเดือน</span>
                <div class="flex items-center gap-1">
                  <span class="text-[18px] font-bold text-tol-red leading-7 tracking-[0.018px]"
                    x-text="total.toLocaleString()"></span>
                  <span class="text-[14px] font-medium text-[#1a1c1e] leading-[1.4]">บาท</span>
                </div>
              </div>
              <div class="w-full flex justify-start">
                <span class="text-[10px] text-[rgba(48,60,70,0.8)] leading-[1.4]">(ไม่รวมภาษีมูลค่าเพิ่ม)</span>
              </div>
            </div>
          </template>

          <!-- Lead Form Section -->
          <div class="w-full flex flex-col gap-6 items-center">

            <!-- Title -->
            <p class="text-[24px] font-medium text-charcoal-grey leading-[1.4] text-center">
              กรุณากรอกชื่อและเบอร์โทร เพื่อให้เจ้าหน้าที่ติดต่อกลับ
            </p>

            <!-- Form fields -->
            <div class="w-full max-w-[727px] flex flex-col items-center">
              <form @submit.prevent="submit()" novalidate class="w-full max-w-[727px] flex flex-col gap-4 items-start">

                <!-- Name + Surname (side by side) -->
                <div class="flex gap-[11px] items-start w-full">
                  <!-- ชื่อ -->
                  <div class="w-[358px] min-h-[72px]">
                    <div class="summary-input-wrapper" :class="errors.name ? 'is-error' : ''">
                      <input type="text" id="field_name" x-model="fields.name" placeholder=" " class="summary-input"
                        required>
                      <label for="field_name" class="summary-input-label">ชื่อ<span
                          class="text-tol-red">*</span></label>
                    </div>
                    <p class="text-[12px] text-tol-red mt-1 h-4" x-show="errors.name" x-text="errors.name"></p>
                  </div>

                  <!-- นามสกุล -->
                  <div class="w-[358px] min-h-[72px]">
                    <div class="summary-input-wrapper" :class="errors.surname ? 'is-error' : ''">
                      <input type="text" id="field_surname" x-model="fields.surname" placeholder=" "
                        class="summary-input" required>
                      <label for="field_surname" class="summary-input-label">นามสกุล<span
                          class="text-tol-red">*</span></label>
                    </div>
                    <p class="text-[12px] text-tol-red mt-1 h-4" x-show="errors.surname" x-text="errors.surname"></p>
                  </div>
                </div>

                <!-- เบอร์โทรศัพท์ -->
                <div class="w-[358px] min-h-[72px]">
                  <div class="summary-input-wrapper" :class="errors.phone ? 'is-error' : ''">
                    <input type="tel" id="field_phone" x-model="fields.phone" placeholder=" " class="summary-input"
                      required inputmode="tel" maxlength="10">
                    <label for="field_phone" class="summary-input-label">เบอร์โทรศัพท์<span
                        class="text-tol-red">*</span></label>
                  </div>
                  <p class="text-[12px] text-tol-red mt-1 h-4" x-show="errors.phone" x-text="errors.phone"></p>
                </div>

              </form>

              <!-- Disclaimer -->
              <p class="text-[12px] text-charcoal-grey leading-[1.4] w-full mt-2">
                ท่านจะได้รับการติดต่อกลับเพื่อยืนยันการสมัครจากเจ้าหน้าที่ ภายใน 30 นาที ในเวลาทำการ 8:00 น. – 19:00 น.​
                สำหรับการฝากข้อมูลติดต่อกลับเพื่อสมัครบริการหลังเวลา 19:00 น. จะได้รับการติดต่อในวันถัดไป​
              </p>

              <!-- T&C Link -->
              <button type="button"
                class="w-full h-10 flex items-center justify-center rounded-full text-[12px] text-[#007AD0] leading-4 hover:bg-[rgba(0,122,208,0.08)] transition-colors cursor-pointer">
                ข้อตกลงและเงื่อนไขการสมัครบริการทรูอินเทอร์เน็ต (T&C)​
              </button>
            </div>

          </div>
        </div>

        <!-- API Error -->
        <template x-if="apiError">
          <div class="w-full max-w-[358px] p-3 bg-[#FFF0F0] border border-tol-red rounded-[8px]">
            <p class="text-[13px] text-tol-red" x-text="apiError"></p>
          </div>
        </template>

        <!-- Submit Button -->
        <button type="button" @click="submit()"
          class="bg-tol-red w-[358px] h-10 flex items-center justify-center rounded-full text-[14px] font-medium text-white tracking-[0.014px] hover:opacity-90 transition-opacity cursor-pointer disabled:opacity-50"
          :disabled="loading">
          <span x-show="!loading">สมัครบริการ</span>
          <span x-show="loading" class="inline-flex items-center gap-2">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            กำลังส่ง...
          </span>
        </button>

      </div>
    </div>
  </main>

  <script>
    /**
     * Alpine.data — leadForm
     * Hydrates plan selection from sessionStorage and handles lead form submission.
     */
    document.addEventListener('alpine:init', () => {
      Alpine.data('leadForm', () => {
        const data = loadFromSession();
        return {
          /* Plan data from sessionStorage */
          plan: data ? data.plan : null,
          activeAddons: data ? (data.activeAddons || []) : [],
          total: data ? (data.total || 0) : 0,

          /* Form fields */
          fields: { name: '', surname: '', phone: '' },
          errors: {},
          loading: false,
          apiError: null,

          validate() {
            this.errors = {};
            if (!this.fields.name.trim()) {
              this.errors.name = 'กรุณากรอกชื่อ';
            }
            if (!this.fields.surname.trim()) {
              this.errors.surname = 'กรุณากรอกนามสกุล';
            }
            const phone = this.fields.phone.trim();
            if (!phone) {
              this.errors.phone = 'กรุณากรอกเบอร์โทรศัพท์';
            } else if (!/^0\d{8,9}$/.test(phone)) {
              this.errors.phone = 'เบอร์โทรศัพท์ไม่ถูกต้อง (เช่น 0812345678)';
            }
            return Object.keys(this.errors).length === 0;
          },

          async submit() {
            if (!this.validate()) return;
            this.loading = true;
            this.apiError = null;

            const payload = {
              plan: this.plan,
              addOns: data ? data.addOns : {},
              total: this.total,
              customer: {
                name: (this.fields.name.trim() + ' ' + this.fields.surname.trim()).trim(),
                phone: this.fields.phone.trim(),
              },
            };

            try {
              const res = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              if (!res.ok) throw new Error('Server error: ' + res.status);
              window.location.href = '../myplan-thank-you/';
            } catch (err) {
              window.location.href = '../myplan-thank-you/';
              // Don't forget to remove this after testing
              // this.apiError = 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่อีกครั้ง';
              // console.error('Lead submit error:', err);
            } finally {
              this.loading = false;
            }
          },
        };
      });
    });
  </script>

</body>

</html>